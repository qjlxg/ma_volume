name: 'Tombstone Submerged Bottom åº•éƒ¨ç­›é€‰'

# è§¦å‘æ¡ä»¶
on:
  # 1. è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'tombstone_submerged_bottom.py' # <-- è·¯å¾„å·²æ›´æ–°
      - '.github/workflows/tombstone_submerged_bottom.yml'
  # 2. æ¯å¤©å®šæ—¶è¿è¡Œ (åŒ—äº¬æ—¶é—´ 18:00)
  schedule:
    # cron è¡¨è¾¾å¼ä½¿ç”¨ UTC æ—¶é—´ã€‚åŒ—äº¬æ—¶é—´ (UTC+8) 18:00 å¯¹åº” UTC 10:00
    - cron: '0 10 * * *'
  # 3. å…è®¸æ‰‹åŠ¨è¿è¡Œ
  workflow_dispatch:

jobs:
  run_analysis:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œç›®å½•ä¸ºè„šæœ¬æ‰€åœ¨çš„ç›®å½•ï¼Œæ–¹ä¾¿è„šæœ¬å†…éƒ¨è·¯å¾„ç®¡ç†
    defaults:
      run:
        working-directory: ${{ github.workspace }}

    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        # ç¡®ä¿ä¸‹è½½æ‰€æœ‰æäº¤å†å²ï¼Œä»¥ä¾¿äºåç»­æ“ä½œ
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: pip install pandas

      # ----------------------------------------------------
      # âš ï¸ å…³é”®æ­¥éª¤ï¼šè¿è¡Œç­›é€‰è„šæœ¬
      # ----------------------------------------------------
      - name: ğŸ” è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: python tombstone_submerged_bottom.py # <-- è·¯å¾„å·²æ›´æ–°

      # ----------------------------------------------------
      # å…³é”®æ­¥éª¤ï¼šæäº¤ç»“æœæ–‡ä»¶åˆ°ä»“åº“
      # ----------------------------------------------------
      - name: â• æäº¤ç­›é€‰ç»“æœåˆ°ä»“åº“
        # åŒ¹é…æ‰€æœ‰æ–°å¢çš„ 'YYYYMM/tombstone_submerged_bottom_YYYYMMDDHHMMSS.csv' æ–‡ä»¶
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ‰¾å‡ºæ‰€æœ‰æ–°å¢æˆ–ä¿®æ”¹çš„ YYYYMM ç›®å½•ä¸‹çš„ CSV æ–‡ä»¶
          find . -type d -name "20[0-9][0-9][0-9][0-9]" -exec git add {} \;
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --cached --exit-code; then
              echo "æ²¡æœ‰æ‰¾åˆ°æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶ï¼Œè·³è¿‡æäº¤ã€‚"
          else
              # æäº¤å˜åŠ¨ï¼ŒCommit æ¶ˆæ¯åŒ…å«è¿è¡Œæ—¶é—´å’Œè§¦å‘æ–¹å¼
              COMMIT_MESSAGE="è‡ªåŠ¨æäº¤ï¼š[${{ github.event_name }}] å·¨çŸ³æ²‰åº•ç­›é€‰ç»“æœ $(date +'%Y-%m-%d %H:%M:%S')"
              git commit -m "$COMMIT_MESSAGE"
              git push
              echo "å·²æäº¤æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶ã€‚"
          fi
