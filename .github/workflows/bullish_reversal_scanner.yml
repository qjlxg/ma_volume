# bullish_reversal_scanner.yml

name: 'Bullish Reversal Scanner'

# è§¦å‘æ¡ä»¶ï¼š
# 1. æ¯å¤©åŒ—äº¬æ—¶é—´ 18:00 å®šæ—¶è¿è¡Œ
# 2. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ (push)
# 3. å…è®¸æ‰‹åŠ¨è¿è¡Œ (workflow_dispatch)
on:
  schedule:
    # æ¯å¤© 18:00 åŒ—äº¬æ—¶é—´ (ä¸Šæµ·æ—¶åŒº) è¿è¡Œ
    # GitHub Actions ä½¿ç”¨ UTCã€‚åŒ—äº¬æ—¶é—´ (UTC+8) 18:00 å¯¹åº” UTC æ—¶é—´ 10:00
    - cron: '0 10 * * *'
  push:
    paths:
      - 'bullish_reversal_scanner.py'
      - '.github/workflows/bullish_reversal_scanner.yml'
  workflow_dispatch:
    # å…è®¸åœ¨ GitHub ç•Œé¢ä¸Šé€šè¿‡ 'Run workflow' æŒ‰é’®æ‰‹åŠ¨è§¦å‘

jobs:
  scan_and_save:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿è¿è¡Œæ—¥å¿—å’Œæ—¶é—´æˆ³çš„å‡†ç¡®æ€§
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        # éœ€è¦æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿åç»­çš„ push èƒ½å¤Ÿæ­£å¸¸å·¥ä½œ
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      # æ£€æŸ¥æ‚¨çš„æ•°æ®ç›®å½•ç»“æ„å’Œæ–‡ä»¶
      - name: ğŸ“‚ Verify data files and structure
        run: |
          if [ ! -d "${{ env.STOCK_DATA_DIR }}" ]; then
            echo "Error: Directory ${{ env.STOCK_DATA_DIR }} not found. Please upload your stock data to the stock_data directory."
            exit 1
          fi
          if [ ! -f "${{ env.STOCK_NAMES_FILE }}" ]; then
            echo "Error: ${{ env.STOCK_NAMES_FILE }} not found. Please upload the stock_names.csv file."
            exit 1
          fi
          
      - name: ğŸ”¬ Run Scanner Script
        run: python bullish_reversal_scanner.py
        env:
          STOCK_DATA_DIR: stock_data
          STOCK_NAMES_FILE: stock_names.csv
          
      - name: ğŸ’¾ Commit and Push Results
        # æŸ¥æ‰¾æœ€æ–°çš„ç»“æœæ–‡ä»¶è·¯å¾„ï¼ˆè„šæœ¬å·²åœ¨å¯¹åº”å¹´æœˆç›®å½•ä¸‹ç”Ÿæˆï¼‰
        id: get_output_path
        run: |
          # æŸ¥æ‰¾ä»Šå¤©è¿è¡Œå¯èƒ½åˆ›å»ºçš„æœ€æ–°æ–‡ä»¶è·¯å¾„ (e.g., 2025/12/20251215...csv)
          OUTPUT_PATH=$(find . -path '*/20[0-9][0-9]/[0-1][0-9]/*_bullish_reversal_stocks.csv' -type f -mmin -10 | head -n 1)
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_OUTPUT
          
        # ä»…åœ¨æ‰¾åˆ°ç»“æœæ–‡ä»¶æ—¶æ‰æäº¤
      - name: â¬†ï¸ Push changes (New results)
        if: steps.get_output_path.outputs.OUTPUT_PATH != ''
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          commit_message: "ğŸ¤– Feat: Add new bullish reversal scan results for $(date +%Y-%m-%d)"
          # ä»…ä¸Šä¼ æ–°çš„ç»“æœç›®å½•å’Œæ–‡ä»¶
          force_orphan: true # æ¸…é™¤æ‰€æœ‰æ—§å†…å®¹ï¼Œä»…ä¿ç•™æ–°çš„ç»“æœï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¿ç•™æ‰€æœ‰æ–‡ä»¶
          exclude_assets: '.git, .github, **/*.py, **/*.yml, stock_data, stock_names.csv' 
          # æäº¤æ•´ä¸ªä»“åº“ï¼Œç„¶ååªå…³æ³¨éœ€è¦è·Ÿè¸ªçš„ç›®å½•
          publish_dir: .
