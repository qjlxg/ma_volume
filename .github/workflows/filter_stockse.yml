name: Stock Filter and Push

# 1. è§¦å‘æ¡ä»¶
on:
  # 1.1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual trigger'

  # 1.2. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶é—´) è¿è¡Œ
  # æ³¨æ„ï¼šGitHub Actions è®¡åˆ’ä»»åŠ¡ä½¿ç”¨ UTC æ—¶é—´ã€‚
  # åŒ—äº¬/ä¸Šæµ·æ—¶é—´ (CST/UTC+8) 18:00 å¯¹åº” UTC æ—¶é—´ 10:00ã€‚
  schedule:
    - cron: '0 15 * * *' # æ¯å¤© UTC 10:00 (CST 18:00)

  # 1.3. ä»£ç å˜åŠ¨è‡ªåŠ¨è§¦å‘ï¼šå½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶
  push:
    branches:
      - main # å‡è®¾ä½ çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'filter_stockse.py'
      - '.github/workflows/filter_stockse.yml'

# é»˜è®¤æƒé™è®¾ç½®ï¼Œç¡®ä¿å¯ä»¥æ¨é€ä»£ç åˆ°ä»“åº“
permissions:
  contents: write # å¿…é¡»æœ‰å†™å…¥æƒé™æ‰èƒ½æ¨é€ç»“æœæ–‡ä»¶

jobs:
  filter_and_push:
    runs-on: ubuntu-latest
    
    # è®¾å®šæ—¶åŒºä¸ºä¸Šæµ·æ—¶é—´ (CST/UTC+8)ï¼Œç¡®ä¿æ—¥å¿—å’Œè„šæœ¬å†…éƒ¨çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„
    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4
        # æ·±åº¦è®¾ç½®ä¸º0ï¼Œè·å–æ‰€æœ‰å†å²æ–‡ä»¶ï¼Œè¿™å¯¹äºåæœŸ git add å¯èƒ½ä¼šæœ‰å¸®åŠ©
        with:
          fetch-depth: 0 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # ä½¿ç”¨æœ€æ–°çš„ Python 3 ç‰ˆæœ¬

      - name: âš™ï¸ å®‰è£…ä¾èµ– (Install dependencies)
        run: |
          # å‡è®¾ä½ çš„è„šæœ¬ä¾èµ– pandasï¼Œç”¨äºå¤„ç†CSVå’Œå¹¶è¡Œ
          python -m pip install --upgrade pip
          pip install pandas

      - name: ğŸ“‚ ç¡®ä¿æ•°æ®å’Œåç§°æ–‡ä»¶å­˜åœ¨
        run: |
          # æ£€æŸ¥ stock_data ç›®å½• (æ‰€æœ‰å†å²æ•°æ®) å’Œ stock_names.csv (åç§°åŒ¹é…æ–‡ä»¶)
          if [ ! -d "stock_data" ]; then
            echo "é”™è¯¯: ç¼ºå°‘ stock_data ç›®å½•ã€‚è¯·ç¡®ä¿æ‰€æœ‰CSVæ•°æ®å·²ä¸Šä¼ åˆ°æ­¤ç›®å½•ã€‚"
            exit 1
          fi
          if [ ! -f "stock_names.csv" ]; then
            echo "è­¦å‘Š: ç¼ºå°‘ stock_names.csv æ–‡ä»¶ã€‚å°†æ— æ³•åŒ¹é…è‚¡ç¥¨åç§°ï¼Œä½†è„šæœ¬ä»ä¼šè¿è¡Œã€‚"
          fi

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        # è„šæœ¬å°†ç”Ÿæˆç»“æœåˆ° filtered_results/YYYY/MM/filtered_stocks_YYYYMMDD_HHMMSS.csv
        run: python filter_stockse.py
        
      # æ³¨æ„ï¼šå·¥ä½œæµè¦æ±‚ä¸è¦ä¸Šä¼ åˆ°å·¥ä»¶ (artifacts)ï¼Œå› æ­¤ç›´æ¥è¿›è¡Œ git commit å’Œ pushã€‚

      - name: ğŸ’¾ æäº¤å¹¶æ¨é€ç»“æœæ–‡ä»¶åˆ°ä»“åº“
        id: git_push
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„æ–‡ä»¶ç”Ÿæˆ (æ–°ç›®å½•æˆ–æ–‡ä»¶)
          # ä»…æ·»åŠ æ–°ç”Ÿæˆçš„ filtered_results ç›®å½•ä¸‹çš„æ–‡ä»¶
          if [ -d "filtered_results" ]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            
            # æŸ¥æ‰¾æ‰€æœ‰æ–°ç”Ÿæˆçš„æ–‡ä»¶å¹¶æ·»åŠ åˆ°æš‚å­˜åŒº
            find filtered_results -type f -newermt "1 minute ago" -print0 | xargs -0 git add
            
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦æäº¤
            if ! git diff --cached --exit-code; then
              COMMIT_MESSAGE="Auto: Filtered stock results for $(date +'%Y-%m-%d %H:%M:%S')"
              git commit -m "$COMMIT_MESSAGE"
              
              # æ¨é€æ›´æ”¹åˆ°å½“å‰åˆ†æ”¯
              git push
              echo "status=pushed" >> $GITHUB_OUTPUT
            else
              echo "status=no_changes" >> $GITHUB_OUTPUT
              echo "æ²¡æœ‰æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶éœ€è¦æäº¤ã€‚"
            fi
          else
            echo "status=no_results_dir" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° filtered_results ç›®å½•ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      - name: ğŸ‰ æ‰“å°æœ€ç»ˆçŠ¶æ€
        run: |
          if [ "${{ steps.git_push.outputs.status }}" == "pushed" ]; then
            echo "âœ… ç­›é€‰ç»“æœå·²æˆåŠŸç”Ÿæˆå¹¶æ¨é€åˆ°ä»“åº“ã€‚"
          elif [ "${{ steps.git_push.outputs.status }}" == "no_changes" ]; then
            echo "â„¹ï¸ è„šæœ¬è¿è¡Œå®Œæˆï¼Œä½†æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–°ç»“æœæ–‡ä»¶éœ€è¦æäº¤ã€‚"
          else
            echo "âš ï¸ è„šæœ¬è¿è¡Œæˆ–æäº¤è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          fi
