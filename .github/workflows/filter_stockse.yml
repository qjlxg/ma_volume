# 默认权限设置，确保可以推送代码到仓库
permissions:
  contents: write # 必须有写入权限才能推送结果文件

jobs:
  filter_and_push:
    runs-on: ubuntu-latest
    
    # 设定时区为上海时间 (CST/UTC+8)，确保日志和脚本内部的时间戳是正确的
    env:
      TZ: Asia/Shanghai

    steps:
      - name: 📥 检出代码 (Checkout repository)
        uses: actions/checkout@v4
        # 深度设置为0，获取所有历史文件，这对于后期 git add 可能会有帮助
        with:
          fetch-depth: 0 

      - name: 🐍 设置 Python 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' # 使用最新的 Python 3 版本

      - name: ⚙️ 安装依赖 (Install dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: 📂 确保数据和名称文件存在
        run: |
          if [ ! -d "stock_data" ]; then
            echo "错误: 缺少 stock_data 目录。请确保所有CSV数据已上传到此目录。"
            exit 1
          fi
          if [ ! -f "stock_names.csv" ]; then
            echo "警告: 缺少 stock_names.csv 文件。将无法匹配股票名称，但脚本仍会运行。"
          fi

      - name: 🚀 运行股票筛选脚本
        run: python filter_stockse.py
        
      - name: 💾 提交并推送结果文件到仓库 (已添加 pull --rebase)
        id: git_push
        run: |
          # 检查是否有新的文件生成 (新目录或文件)
          if [ -d "filtered_results" ]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            
            # 查找所有新生成的文件并添加到暂存区 (通常是过去一分钟内创建的文件)
            find filtered_results -type f -newermt "1 minute ago" -print0 | xargs -0 git add
            
            # 检查是否有文件需要提交
            if ! git diff --cached --exit-code; then
              COMMIT_MESSAGE="Auto: Filtered stock results for $(date +'%Y-%m-%d %H:%M:%S')"
              git commit -m "$COMMIT_MESSAGE"
              
              # *** 关键修复步骤：先拉取远程最新代码并进行 Rebase 合并 ***
              # 这解决了 'rejected (fetch first)' 的错误
              git pull --rebase
              
              # 推送更改到当前分支
              git push
              echo "status=pushed" >> $GITHUB_OUTPUT
            else
              echo "status=no_changes" >> $GITHUB_OUTPUT
              echo "没有新的筛选结果文件需要提交。"
            fi
          else
            echo "status=no_results_dir" >> $GITHUB_OUTPUT
            echo "未找到 filtered_results 目录，跳过提交。"
          fi

      - name: 🎉 打印最终状态
        run: |
          if [ "${{ steps.git_push.outputs.status }}" == "pushed" ]; then
            echo "✅ 筛选结果已成功生成并推送到仓库。"
          elif [ "${{ steps.git_push.outputs.status }}" == "no_changes" ]; then
            echo "ℹ️ 脚本运行完成，但没有符合条件的新结果文件需要提交。"
          else
            echo "⚠️ 脚本运行或提交过程中可能出现问题，请检查日志。"
          fi
