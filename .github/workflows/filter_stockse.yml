name: Stock Filter and Push

on:
  workflow_dispatch:

  schedule:
    - cron: '26 15 * * *' 

  push:
    branches:
      - main
    paths:
      - 'filter_stockse.py'
      - '.github/workflows/filter_stockse.yml'

permissions:
  contents: write

jobs:
  filter_and_push:
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (Install dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install pandas

      - name: ğŸ“‚ ç¡®ä¿æ•°æ®å’Œåç§°æ–‡ä»¶å­˜åœ¨
        run: |
          if [ ! -d "stock_data" ]; then
            echo "é”™è¯¯: ç¼ºå°‘ stock_data ç›®å½•ã€‚è¯·ç¡®ä¿æ‰€æœ‰CSVæ•°æ®å·²ä¸Šä¼ åˆ°æ­¤ç›®å½•ã€‚"
            exit 1
          fi
          if [ ! -f "stock_names.csv" ]; then
            echo "è­¦å‘Š: ç¼ºå°‘ stock_names.csv æ–‡ä»¶ã€‚å°†æ— æ³•åŒ¹é…è‚¡ç¥¨åç§°ï¼Œä½†è„šæœ¬ä»ä¼šè¿è¡Œã€‚"
          fi

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: python filter_stockse.py
        
      - name: ğŸ’¾ æäº¤å¹¶æ¨é€ç»“æœæ–‡ä»¶åˆ°ä»“åº“
        id: git_push
        run: |
          if [ -d "filtered_results" ]; then
            git config user.name 'github-actions[bot]'
            git config user.email 'github-actions[bot]@users.noreply.github.com'
            
            find filtered_results -type f -newermt "1 minute ago" -print0 | xargs -0 git add
            
            if ! git diff --cached --exit-code; then
              COMMIT_MESSAGE="Auto: Filtered stock results for $(date +'%Y-%m-%d %H:%M:%S')"
              git commit -m "$COMMIT_MESSAGE"
              
              git pull origin main --rebase
              
              git push
              echo "status=pushed" >> $GITHUB_OUTPUT
            else
              echo "status=no_changes" >> $GITHUB_OUTPUT
              echo "æ²¡æœ‰æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶éœ€è¦æäº¤ã€‚"
            fi
          else
            echo "status=no_results_dir" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ° filtered_results ç›®å½•ï¼Œè·³è¿‡æäº¤ã€‚"
          fi

      - name: ğŸ‰ æ‰“å°æœ€ç»ˆçŠ¶æ€
        run: |
          if [ "${{ steps.git_push.outputs.status }}" == "pushed" ]; then
            echo "âœ… ç­›é€‰ç»“æœå·²æˆåŠŸç”Ÿæˆå¹¶æ¨é€åˆ°ä»“åº“ã€‚"
          elif [ "${{ steps.git_push.outputs.status }}" == "no_changes" ]; then
            echo "â„¹ï¸ è„šæœ¬è¿è¡Œå®Œæˆï¼Œä½†æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„æ–°ç»“æœæ–‡ä»¶éœ€è¦æäº¤ã€‚"
          else
            echo "âš ï¸ è„šæœ¬è¿è¡Œæˆ–æäº¤è¿‡ç¨‹ä¸­å¯èƒ½å‡ºç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚"
          fi
