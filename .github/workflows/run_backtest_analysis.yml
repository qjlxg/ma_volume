# .github/workflows/backtest.yml

name: Stock Screener Backtest & Publish ğŸ“ˆ

on:
  # 1. è‡ªåŠ¨è§¦å‘ï¼šå½“æ ¸å¿ƒè„šæœ¬æˆ–æœ¬å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶
  push:
    branches:
      - main
    paths:
      - 'stock_screener_core.py'
      - 'backtest_screener.py'
      - '.github/workflows/backtest.yml'
      
  # 2. å®šæ—¶è§¦å‘ï¼šæ¯æ—¥æ—©ä¸Š 9:00 (ä¸Šæµ·æ—¶é—´) è¿è¡Œ
  schedule:
    # cron è¡¨è¾¾å¼æ˜¯ UTC æ—¶é—´ã€‚ä¸Šæµ·æ—¶é—´ 9:00 (UTC+8) å¯¹åº” UTC 1:00
    - cron: '0 1 * * *'
    
  # 3. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    
env:
  # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿å®šæ—¶å’Œæ—¥å¿—æ—¶é—´æ­£ç¡®
  TZ: Asia/Shanghai

jobs:
  backtest:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥ä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Python ç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy
        
    - name: å‡†å¤‡å†å²æ•°æ®
      run: |
        if [ ! -d "stock_data" ]; then
          echo "Warning: stock_data directory not found. Backtest will likely fail."
        else
          echo "Success: stock_data directory found."
        fi
        
    - name: æ‰§è¡Œå›æµ‹è„šæœ¬
      id: run-backtest
      run: |
        # åˆ›å»ºç»“æœç›®å½•
        mkdir -p backtest_results
        # æ‰§è¡Œå›æµ‹è„šæœ¬ã€‚è„šæœ¬è‡ªå¸¦çš„ print è¯­å¥å°†è¾“å‡ºæ‘˜è¦åˆ°æ—¥å¿—ã€‚
        python backtest_screener.py
        
    - name: æ€»ç»“å›æµ‹ç»“æœåˆ° Actions æ—¥å¿— (ä½¿ç”¨è„šæœ¬è‡ªå¸¦çš„æ‰“å°å†…å®¹)
      if: success()
      run: |
        RESULTS_FILE=$(ls backtest_results/*.csv | head -n 1)
        
        if [ -f "$RESULTS_FILE" ]; then
          echo "--- å›æµ‹å·²å®Œæˆï¼Œç»“æœå·²ç”Ÿæˆ ---"
          echo "è¯¦ç»†ç»“æœæ–‡ä»¶è·¯å¾„: $RESULTS_FILE"
          echo "--------------------------------"
        fi
        
    - name: é…ç½® Git ç¯å¢ƒ (ç”¨äºæ¨é€ç»“æœ)
      if: success()
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
    - name: æäº¤å¹¶æ¨é€å›æµ‹ç»“æœåˆ°ä»“åº“
      if: success()
      run: |
        # è·å–æœ€æ–°çš„ç»“æœæ–‡ä»¶å
        RESULTS_FILE=$(ls backtest_results/*.csv | head -n 1)
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶ç”Ÿæˆ
        if [ -f "$RESULTS_FILE" ]; then
          git add $RESULTS_FILE
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŠ¨ï¼Œå¹¶æäº¤
          if git diff --cached --exit-code; then
              echo "æ²¡æœ‰æ–°çš„å›æµ‹ç»“æœå˜åŠ¨ï¼Œè·³è¿‡æäº¤ã€‚"
          else
              git commit -m "ğŸ“ˆ Auto: Backtest results for $(date +%Y-%m-%d)"
              # æ¨é€å› main åˆ†æ”¯
              git push
              echo "å›æµ‹ç»“æœå·²æˆåŠŸæ¨é€åˆ°ä»“åº“ã€‚"
          fi
        else
          echo "æœªç”Ÿæˆå›æµ‹ç»“æœæ–‡ä»¶ï¼Œè·³è¿‡ Git æ¨é€ã€‚"
        fi
