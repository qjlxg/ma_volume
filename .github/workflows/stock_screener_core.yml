name: ğŸ“ˆ æ¨¡å¼1/2 

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ– YAML æ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    paths:
      - 'stock_screener_core.py'
      - '.github/workflows/stock_screener_core.yml'
  
  # 3. æ¯å¤©å®šæ—¶è§¦å‘ (åŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶é—´ 18:00)
  schedule:
    - cron: '10 14 * * *'

jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· (åŒ—äº¬æ—¶é—´)
    env:
      TZ: Asia/Shanghai

    steps:
    - name: 1. æ£€å‡ºä»£ç  (Checkout Repository)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: 2. è®¾ç½® Python ç¯å¢ƒ (Setup Python)
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: 3. å®‰è£…ä¾èµ– (Install Dependencies)
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy

    - name: 4. è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬ (Run Screener - åŒ…å«å¹¶è¡Œå¤„ç†)
      run: python stock_screener_core.py
      
    - name: 5. æ£€æŸ¥å¹¶æ¨é€ç­›é€‰ç»“æœ (Commit and Push Results)
      id: commit
      run: |
        # é…ç½® Git
        git config --global user.name 'GitHub Actions Screener'
        git config --global user.email 'actions@github.com'
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ CSV æ–‡ä»¶ç”Ÿæˆ
        if git status --porcelain | grep 'screened_results/'; then
          echo "Found new results. Proceeding to commit."
          git add screened_results/
          
          # ä½¿ç”¨ç³»ç»Ÿç¯å¢ƒå˜é‡ TZ è·å–å‡†ç¡®çš„ä¸Šæµ·æ—¶é—´ç”¨äº Commit æ¶ˆæ¯
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ“ˆ Auto: Add stock screening results for ${TIMESTAMP} (Shanghai Time)"
          
          # ** FIX: æ‹‰å–è¿œç¨‹æ›´æ–°å¹¶å˜åŸºï¼ˆrebaseï¼‰ï¼Œè§£å†³å†²çª **
          # ${{ github.ref_name }} æ˜¯å½“å‰åˆ†æ”¯çš„åç§°
          git pull --rebase origin ${{ github.ref_name }}
          
          # æ¨é€åˆ°ä»“åº“
          git push
        else
          echo "No new screening results found. Skipping commit."
        fi
      if: success()
