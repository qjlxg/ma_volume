name: ğŸ“ˆ Rising Three Methods Scanner (å å½¢å¤šæ–¹ç‚®)

# å·¥ä½œæµçš„åç§°ä¸è„šæœ¬åç§°ä¸€è‡´ï¼Œä¾¿äºåŒºåˆ†
run-name: ${{ github.event_name == 'workflow_dispatch' && format('æ‰‹åŠ¨è¿è¡Œ - å å½¢å¤šæ–¹ç‚®æ‰«æ') || format('{0} è§¦å‘ - å å½¢å¤šæ–¹ç‚®æ‰«æ', github.event_name) }}

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 2. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) è¿è¡Œ
  # GitHub Actions ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ (CST/GMT+8) 18:00 å¯¹åº” UTC 10:00
  schedule:
    - cron: '0 10 * * *'
    
  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    paths:
      - 'rising_three_methods_scanner.py'
      - '.github/workflows/rising_three_methods_workflow.yml'

jobs:
  scan_and_save:
    # ä½¿ç”¨æœ€æ–°çš„ Ubuntu è¿è¡Œç¯å¢ƒ
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç  (Checkout Repository)
        uses: actions/checkout@v4
        
      # ç¡®ä¿æ‰€æœ‰ä¸Šä¼ çš„CSVæ–‡ä»¶ï¼ˆåŒ…æ‹¬stock_dataç›®å½•ä¸‹çš„æ–‡ä»¶ï¼‰éƒ½å­˜åœ¨
      - name: ğŸ“ æ£€æŸ¥å¹¶åˆ›å»ºæ•°æ®ç›®å½•ç»“æ„
        run: |
          mkdir -p stock_data
          # æ£€æŸ¥ç”¨æˆ·ä¸Šä¼ çš„ç¤ºä¾‹æ–‡ä»¶ï¼Œå®ƒä»¬åº”è¢«æ”¾ç½®åœ¨æ­£ç¡®çš„ä½ç½®
          # å‡è®¾ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆå¦‚603693.csvï¼‰åœ¨ä»“åº“æ ¹ç›®å½•ï¼Œæˆ‘ä»¬éœ€è¦ç§»åŠ¨æˆ–ç¡®ä¿å®ƒä»¬åœ¨ stock_data ä¸­
          # å®é™…éƒ¨ç½²æ—¶ï¼Œè¯·ç¡®ä¿æ‚¨çš„stock_dataç›®å½•ç»“æ„æ˜¯æ­£ç¡®çš„
          echo "è¯·ç¡®ä¿æ‰€æœ‰CSVæ•°æ®æ–‡ä»¶éƒ½æ”¾ç½®åœ¨ 'stock_data/' ç›®å½•ä¸‹ï¼Œä¾‹å¦‚ï¼šstock_data/603693.csv"
          
      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ– (Pandas, Multiprocessing)
        run: pip install pandas

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨å½¢æ€æ‰«æè„šæœ¬
        run: python rising_three_methods_scanner.py

      - name: ğŸ’¾ æ¨é€ç»“æœåˆ°ä»“åº“ (Push Results to Repository)
        # å¦‚æœæ²¡æœ‰æ–°çš„æ–‡ä»¶ç”Ÿæˆï¼Œè¿™ä¸€æ­¥ä¼šè·³è¿‡ï¼Œä½†é€šå¸¸è„šæœ¬ä¼šç”Ÿæˆç»“æœæ–‡ä»¶
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„è¾“å‡ºæ–‡ä»¶ç”Ÿæˆ
          if [ -d "output" ]; then
            git add output
            # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å®é™…è¢«æ·»åŠ æˆ–ä¿®æ”¹
            if git status --porcelain | grep -q "output"; then
              TIMESTAMP=$(date -u +%Y%m%d%H%M%S)
              git commit -m "ğŸ¤– [Action] è‡ªåŠ¨æ¨é€ 'å å½¢å¤šæ–¹ç‚®' æ‰«æç»“æœ (${TIMESTAMP})"
              git push
            else
              echo "æ²¡æœ‰æ–°çš„ç»“æœæ–‡ä»¶ç”Ÿæˆï¼Œè·³è¿‡ Git Commit å’Œ Pushã€‚"
            fi
          else
            echo "æœªæ‰¾åˆ° 'output' ç›®å½•ï¼Œå¯èƒ½æœªå‘ç°ç¬¦åˆå½¢æ€çš„è‚¡ç¥¨ï¼Œè·³è¿‡ Git Commit å’Œ Pushã€‚"
          fi
