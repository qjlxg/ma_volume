name: ğŸ“ˆ Stock Screener: Low Cost Christmas Pattern

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) / 10:00 (UTC)
  # GitHub Actions å®šæ—¶ä»»åŠ¡ä½¿ç”¨ UTC æ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´ (BJT) æ˜¯ UTC+8
  schedule:
    # æ¯å¤© 18:00 BJT = æ¯å¤© 10:00 UTC
    - cron: '0 10 * * *' 
  
  # 2. æ‰‹åŠ¨è§¦å‘ (workflow_dispatch)
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (Shanghai Time Zone Check)'
        required: false
        default: 'Manual trigger for immediate screening'

  # 3. è„šæœ¬æˆ–å·¥ä½œæµå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ (push/pull_request)
  push:
    branches:
      - main  # ç›‘å¬ main åˆ†æ”¯çš„æ¨é€
    paths:
      - 'filter_stocks.py' # è„šæœ¬å˜åŠ¨
      - '.github/workflows/stock_screener.yml' # å·¥ä½œæµå˜åŠ¨
  pull_request:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'

jobs:
  filter_and_commit:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œç¯å¢ƒçš„æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)
    # è¿™ç¡®ä¿äº† Python è„šæœ¬ä¸­çš„ datetime.now(pytz.timezone('Asia/Shanghai')) ç»“æœæ­£ç¡®
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout Repository (Fetch History)
        uses: actions/checkout@v4
        # å¿…é¡»æ‹‰å–å®Œæ•´çš„å†å²è®°å½• (fetch-depth: 0)ï¼Œä»¥ä¾¿åç»­çš„ git push æ“ä½œ
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          # å®‰è£…å¿…è¦çš„Pythonåº“ï¼špandas (æ•°æ®å¤„ç†), pytz (æ—¶åŒº), multiprocessing (å¹¶è¡Œ)
          python -m pip install --upgrade pip
          pip install pandas pytz 

      - name: ğŸƒ Run Stock Filter Script
        # è¿è¡Œ Python è„šæœ¬ã€‚å®ƒå°†è‡ªåŠ¨åˆ›å»º results/å¹´-æœˆ/ æ–‡ä»¶ã€‚
        run: python filter_stocks.py
        
      - name: ğŸ’¾ Configure Git for Commit
        # é…ç½® Git ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨äºè‡ªåŠ¨æäº¤
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com # ä½¿ç”¨æ ‡å‡†çš„ bot é‚®ç®±

      - name: ğŸš€ Commit and Push Results
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶ç”Ÿæˆå¹¶æäº¤
        run: |
          # æ£€æŸ¥ results/ ç›®å½•ä¸‹æ˜¯å¦æœ‰å˜åŒ– (æ–°å¢æˆ–ä¿®æ”¹æ–‡ä»¶)
          if git status --porcelain | grep 'results/'; then
            echo "New or modified results found, staging files..."
            git add results/
            
            # ä½¿ç”¨ä¸Šæµ·æ—¶åŒºçš„æ—¶é—´ä½œä¸º commit ä¿¡æ¯
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
            git commit -m "ğŸ“ˆ Auto-Screen: Results pushed at ${COMMIT_TIME} (Shanghai)"
            
            echo "Committing and pushing results..."
            git push
            echo "Results pushed successfully to main branch."
          else
            echo "No changes in results directory. Nothing to commit."
          fi
