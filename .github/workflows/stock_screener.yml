name: ğŸ“ˆ Stock Screener
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) / 10:00 (UTC)
  schedule:
    - cron: '0 10 * * *' 
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run trigger'
        required: false
        default: 'Manual screening execution'

  # 3. è„šæœ¬æˆ–å·¥ä½œæµå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'

jobs:
  filter_and_commit:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œç¯å¢ƒçš„æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout Repository (Fetch History)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æ‹‰å–å†å²è®°å½•ä»¥ä¾¿æ¨é€ç»“æœ
          fetch-depth: 0

      - name: âš™ï¸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Python Dependencies
        run: pip install pandas pytz

      - name: ğŸƒ Run Stock Filter Script
        run: python filter_stocks.py
        
      - name: ğŸ’¾ Configure Git
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
      # ğŸš€ Commit and Push Results æ­¥éª¤æ‹†åˆ†ï¼Œæ›´ç¨³å®šåœ°æ£€æµ‹å˜åŒ–
      - name: ğŸ” Check for New Results
        id: check
        run: |
          # æ£€æŸ¥ results/ ç›®å½•ä¸ HEAD ä¹‹é—´æ˜¯å¦å­˜åœ¨å·®å¼‚ (å³æ˜¯å¦æœ‰æ–°æ–‡ä»¶æˆ–ä¿®æ”¹)
          # ä½¿ç”¨ git diff --exit-code æ›´å¯é åœ°æ£€æµ‹å˜åŒ–
          if git diff --exit-code --quiet HEAD -- results/; then
            echo "::set-output name=changes::false"
          else
            echo "::set-output name=changes::true"
          fi

      - name: ğŸ“ Commit New Results
        if: steps.check.outputs.changes == 'true'
        run: |
          git add results/
          
          # è®¾ç½®æäº¤æ—¶é—´å˜é‡
          COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
          
          # æäº¤å¹¶æ¨é€
          git commit -m "ğŸ“ˆ Auto-Screen: Results pushed at ${COMMIT_TIME} (Shanghai)"
          git push
          echo "Results pushed successfully."
          
      - name: â„¹ï¸ No Changes Detected
        if: steps.check.outputs.changes == 'false'
        run: echo "No changes in results directory. Nothing to commit."
