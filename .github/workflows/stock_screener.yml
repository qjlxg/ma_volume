name: Stock Screener

on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) / 10:00 (UTC)
  schedule:
    - cron: '0 15 * * *' 
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run trigger'
        required: false
        default: 'Manual screening execution'

  # 3. è„šæœ¬æˆ–å·¥ä½œæµå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'

jobs:
  filter_and_commit:
    runs-on: ubuntu-latest
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout Repository (Fetch History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Python Dependencies
        run: pip install pandas pytz

      - name: ğŸƒ Run Stock Filter Script
        run: python filter_stocks.py
        
      - name: ğŸ’¾ Configure Git
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          
      - name: ğŸš€ Commit and Push Results (ä¿®å¤Gitæ£€æµ‹)
        run: |
          # 1. å¼ºåˆ¶è¿½è¸ª results/ ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ (åŒ…æ‹¬æ–°å»ºçš„)
          git add results/
          
          # 2. ä½¿ç”¨ git status --porcelain æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶åœ¨æš‚å­˜åŒºç­‰å¾…æäº¤
          # å¦‚æœæœ‰è¾“å‡ºï¼Œè¯´æ˜ git add results/ æˆåŠŸæ·»åŠ äº†æ–°æ–‡ä»¶æˆ–ä¿®æ”¹è¿‡çš„æ–‡ä»¶
          if git status --porcelain | grep 'results/'; then
            echo "New results found, commencing commit..."
            
            # ä½¿ç”¨ä¸Šæµ·æ—¶åŒºçš„æ—¶é—´ä½œä¸º commit ä¿¡æ¯
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
            
            # æäº¤å¹¶æ¨é€
            git commit -m "ğŸ“ˆ Auto-Screen: Results pushed at ${COMMIT_TIME} (Shanghai)"
            git push
            echo "Results pushed successfully."
          else
            echo "No new changes or modifications in results directory after screening. Nothing to commit."
          fi
