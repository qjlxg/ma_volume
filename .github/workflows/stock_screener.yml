name: ğŸ“ˆ Stock Screener: Low Cost Christmas Pattern

# è§¦å‘æ¡ä»¶
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) / 10:00 (UTC)
  # BJT (UTC+8) 18:00 = UTC 10:00
  schedule:
    - cron: '0 10 * * *' 
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (Shanghai Time Zone Check)'
        required: false
        default: 'Manual trigger for immediate screening'

  # 3. è„šæœ¬æˆ–å·¥ä½œæµå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'filter_stocks.py'
      - '.github/workflows/stock_screener.yml'

jobs:
  filter_and_commit:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œç¯å¢ƒçš„æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº (Asia/Shanghai)ï¼Œç¡®ä¿ Python è„šæœ¬çš„æ—¶é—´æˆ³æ­£ç¡®
    env:
      TZ: Asia/Shanghai

    steps:
      - name: â¬‡ï¸ Checkout Repository (Fetch History)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æ‹‰å–å†å²è®°å½•ä»¥ä¾¿æ¨é€ç»“æœ
          fetch-depth: 0

      - name: âš™ï¸ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ Install Python Dependencies
        run: |
          # å®‰è£… pandas å’Œ pytz åº“
          python -m pip install --upgrade pip
          pip install pandas pytz 

      - name: ğŸƒ Run Stock Filter Script
        # è¿è¡Œ Python è„šæœ¬ï¼Œå¹¶è‡ªåŠ¨åˆ›å»º results/å¹´-æœˆ/ æ–‡ä»¶
        run: python filter_stocks.py
        
      - name: ğŸ’¾ Configure Git for Commit
        run: |
          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com

      - name: ğŸš€ Commit and Push Results
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç­›é€‰ç»“æœæ–‡ä»¶ç”Ÿæˆå¹¶æäº¤
        run: |
          # æ£€æŸ¥ results/ ç›®å½•ä¸‹æ˜¯å¦æœ‰æ–‡ä»¶éœ€è¦è¢« git è¿½è¸ª
          if git status --porcelain | grep 'results/'; then
            echo "New results found, staging files..."
            git add results/
            
            # ä½¿ç”¨ä¸Šæµ·æ—¶åŒºçš„æ—¶é—´ä½œä¸º commit ä¿¡æ¯
            COMMIT_TIME=$(date '+%Y-%m-%d %H:%M:%S %Z')
            git commit -m "ğŸ“ˆ Auto-Screen: Results pushed at ${COMMIT_TIME} (Shanghai)"
            
            echo "Committing and pushing results..."
            git push
            echo "Results pushed successfully."
          else
            echo "No changes in results directory. Nothing to commit."
          fi
