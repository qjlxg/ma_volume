# .github/workflows/ma_trend_weakness_screen.yml

name: å¼±åŠ¿

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual run by user'

  # 2. ä»£ç å˜åŠ¨è§¦å‘ (è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶)
  push:
    branches:
      - main # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'ma_trend_weakness_screen.py'
      - '.github/workflows/ma_trend_weakness_screen.yml'

  # 3. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 åŒ—äº¬æ—¶é—´ (UTC+8)
  # 18:00 BJT ç­‰åŒäº 10:00 UTC (cron è¡¨è¾¾å¼ä»¥ UTC ä¸ºåŸºå‡†)
  schedule:
    - cron: '0 15 * * *'

jobs:
  run_screening_and_push:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›ï¸ æ£€å‡ºä»£ç  (Checkout repository)
        uses: actions/checkout@v4
        with:
          # å¿…é¡»å¼€å¯ fetch-depth: 0 æ‰èƒ½è®© git-auto-commit-action æ­£ç¡®å·¥ä½œ
          fetch-depth: 0 

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ (Set up Python)
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: âš™ï¸ å®‰è£…ä¾èµ–åº“ (Install dependencies)
        run: |
          python -m pip install --upgrade pip
          pip install pandas pytz

      - name: ğŸš€ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬ (Run stock screening script)
        run: python ma_trend_weakness_screen.py
        
      - name: ğŸ’¾ æäº¤ç­›é€‰ç»“æœåˆ°ä»“åº“ (Commit and push results)
        # ä½¿ç”¨ git-auto-commit-action è‡ªåŠ¨å°†æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶æ¨é€åˆ°ä»“åº“
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # ä»…æäº¤æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶å’Œå…¶æ‰€åœ¨çš„ç›®å½• (YYYY/MM/)
          file_pattern: '**/*.csv'
          commit_message: 'ğŸ¤– Auto: è‚¡ç¥¨å‡çº¿å¼±åŠ¿ç­›é€‰ç»“æœæ›´æ–° (MA Trend Weakness Screen)'
          # ç¡®ä¿æäº¤ç”¨æˆ·åå’Œé‚®ç®±è®¾ç½®æ­£ç¡®
          commit_author: 'GitHub Actions <actions@github.com>'
          # ä¸æŒ‡å®š branchï¼Œé»˜è®¤ä¸ºå½“å‰åˆ†æ”¯
