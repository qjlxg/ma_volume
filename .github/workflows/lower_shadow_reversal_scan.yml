name: ä¸‹å½±çº¿åè½¬

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
  
  # 2. è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main # å‡è®¾ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'lower_shadow_reversal_scan.py'
      - '.github/workflows/lower_shadow_reversal_scan.yml'
      
  # 3. æ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) å®šæ—¶è§¦å‘
  # 18:00 BJT (UTC+8) å¯¹åº” 10:00 UTC
  schedule:
    - cron: '0 10 * * *'

# è®¾ç½®è¿è¡Œç¯å¢ƒä¸ºä¸Šæµ·æ—¶åŒºï¼Œå½±å“ runner çš„æ—¥å¿—å’Œç³»ç»Ÿæ—¶é—´
env:
  TZ: 'Asia/Shanghai'

jobs:
  scan_and_commit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      # å¿…é¡»ä½¿ç”¨ fetch-depth: 0 æ‰èƒ½åœ¨åç»­æ­¥éª¤ä¸­æ¨é€æ–°æ–‡ä»¶
      with:
        fetch-depth: 0 

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        # å®‰è£… pandas, pytz, multiprocessing æ˜¯å†…ç½®çš„
        pip install pandas pytz
        
    - name: Run Stock Scanner Script
      # è¿è¡Œ Python è„šæœ¬
      run: python lower_shadow_reversal_scan.py
      
    - name: Configure Git for Commit
      run: |
        git config user.name 'github-actions[bot]'
        git config user.email 'github-actions[bot]@users.noreply.github.com'
        
    - name: Commit and Push Results
      # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç»“æœæ–‡ä»¶ç”Ÿæˆæˆ–ç°æœ‰æ–‡ä»¶è¢«ä¿®æ”¹
      run: |
        git add --all
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
        if git diff --cached --exit-code; then
          echo "No changes found. Exiting."
        else
          # å¦‚æœæœ‰å˜åŠ¨ï¼Œæäº¤å¹¶æ¨é€
          git commit -m "ğŸ¤– Auto scan: Lower Shadow Reversal results update."
          git push
        fi
