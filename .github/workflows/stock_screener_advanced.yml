name: Stock Screener Advanced Workflow

# è§¦å‘å™¨é…ç½®
on:
  # 1. æ‰‹åŠ¨è§¦å‘ (åœ¨ Actions é¡µé¢ç‚¹å‡» Run workflow)
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'

  # 2. æ¯å¤©å®šæ—¶è¿è¡Œ (åŒ—äº¬æ—¶é—´ 18:00)
  schedule:
    # UTC æ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '0 15 * * *' 
  
  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'


jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œæµçš„è¿è¡Œæ—¶åŒºä¸ºä¸Šæµ· (åŒ—äº¬æ—¶é—´)ï¼Œç¡®ä¿æ—¥å¿—å’Œæ—¶é—´æˆ³ä¸€è‡´
    env:
      TZ: 'Asia/Shanghai' 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      # ç¡®ä¿ stock_data å’Œ stock_names.csv åœ¨ä»“åº“ä¸­

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Dependencies (pandas)
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py

    - name: ğŸ’¾ Commit and Push Results
      # ä½¿ç”¨ stefanzweifel/git-auto-commit-action å°† output ç›®å½•ä¸‹çš„ç»“æœæ–‡ä»¶æäº¤åˆ°ä»“åº“
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        # ä¿®æ­£ï¼šä½¿ç”¨ file_pattern åŒ¹é… output/YYYY-MM/screener_...csv æ–‡ä»¶
        file_pattern: output/**/*.csv 
        # è®¾ç½® Git commit æ—¶é—´æˆ³ä¸ºä¸Šæµ·æ—¶åŒº
        commit_options: '--date="${{ env.TZ_OFFSET }}"'
        pull_options: '--rebase'
      env:
        # å®šä¹‰ UTC+8 offset ä¾› commit_options ä½¿ç”¨
        TZ_OFFSET: '+0800'
