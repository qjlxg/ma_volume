name: Stock Screener Advanced Workflow

# è§¦å‘å™¨é…ç½®
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'

  # 2. æ¯å¤©å®šæ—¶è¿è¡Œ (åŒ—äº¬æ—¶é—´ 18:00)
  schedule:
    # æ¯å¤© 10:00 UTC è¿è¡Œï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '0 15 * * *' 
  
  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾ä½ çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'
      # å¦‚æœ stock_data æˆ– stock_names.csv å˜åŠ¨ä¹Ÿéœ€è¦è¿è¡Œï¼Œè¯·å–æ¶ˆæ³¨é‡Šä»¥ä¸‹è¡Œ
      # - 'stock_data/**'
      # - 'stock_names.csv'


jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· (åŒ—äº¬æ—¶é—´)
    env:
      TZ: 'Asia/Shanghai' 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      # ç¡®ä¿ stock_data ç›®å½•åŠå…¶å†…å®¹å·²æ¨é€åˆ°ä½ çš„GitHubä»“åº“ã€‚

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py

    - name: ğŸ’¾ Commit and Push Results (Excluding Artifacts)
      # æŸ¥æ‰¾æ–°ç”Ÿæˆçš„ output ç›®å½•ï¼Œå¹¶å°†å…¶æ¨é€åˆ°ä»“åº“
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        # åªæäº¤ output ç›®å½•ä¸‹çš„æ–‡ä»¶
        files: output/*.csv output/*/*.csv
        # å°†æ—¶åŒºè®¾ç½®ä¸ºä¸Šæµ·æ—¶åŒºï¼Œä½¿ Git commit æ—¶é—´æˆ³ä¸è¿è¡Œç¯å¢ƒä¸€è‡´
        commit_options: '--date="${{ env.TZ_OFFSET }}"'
      env:
        TZ_OFFSET: '+0800' # UTC+8 offset for commit timestamp
