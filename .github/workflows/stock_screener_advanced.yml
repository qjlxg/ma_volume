name: Stock Screener Advanced Workflow

# è§¦å‘å™¨é…ç½®
on:
  # 1. æ‰‹åŠ¨è§¦å‘ (åœ¨ Actions é¡µé¢ç‚¹å‡» Run workflow)
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'

  # 2. æ¯å¤©å®šæ—¶è¿è¡Œ (åŒ—äº¬æ—¶é—´ 18:00)
  schedule:
    # UTC æ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '0 10 * * *' 
  
  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main  # å‡è®¾æ‚¨çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'


jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    # è®¾ç½®å·¥ä½œæµçš„è¿è¡Œæ—¶åŒºä¸ºä¸Šæµ· (åŒ—äº¬æ—¶é—´)
    env:
      TZ: 'Asia/Shanghai' 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      # ç¡®ä¿ stock_data å’Œ stock_names.csv åœ¨ä»“åº“ä¸­

    # â­ æ–°å¢æ­¥éª¤ï¼šåœ¨è¿è¡Œè„šæœ¬å‰ï¼Œç¡®ä¿æœ¬åœ°åˆ†æ”¯ä¸è¿œç¨‹åŒæ­¥
    - name: ğŸ”„ Git Pull --rebase (Prevent non-fast-forward error)
      run: git pull --rebase
      # âš ï¸ æ³¨æ„ï¼šè¿™ä¸ªæ­¥éª¤è¦æ±‚ actions/checkout@v4 å·²ç»è®¾ç½®äº†æƒé™ï¼Œé»˜è®¤æ˜¯å¯ç”¨çš„ã€‚

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Dependencies (pandas)
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py

    - name: ğŸ’¾ Commit and Push Results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        file_pattern: output/**/*.csv 
        commit_options: '--date="${{ env.TZ_OFFSET }}"'
        # â­ å…³é”®ä¿®æ­£ï¼šç¦ç”¨ Action å†…éƒ¨çš„ Git Fetch/Checkoutï¼Œå› ä¸ºå®ƒåœ¨ pull ä¹‹åæ˜¯å¤šä½™çš„ï¼Œä¸”å¯èƒ½é€ æˆå†²çªã€‚
        skip_fetch: true
        skip_checkout: true 
      env:
        TZ_OFFSET: '+0800'
