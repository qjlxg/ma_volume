name: Stock Screener Advanced Workflow

# è§¦å‘å™¨é…ç½®
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'

  schedule:
    # UTC æ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '0 18 * * *' 
  
  push:
    branches:
      - main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'


jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    # å…³é”®ï¼šç¡®ä¿ Action æœ‰æƒé™å†™å…¥å’Œæ¨é€
    permissions:
      contents: write # æ˜¾å¼æˆäºˆå†™å…¥æƒé™

    env:
      TZ: 'Asia/Shanghai' 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      # âš ï¸ å¿…é¡»ä½¿ç”¨ actions/checkout@v4ï¼Œä»¥ä¾¿åç»­æ“ä½œèƒ½ä½¿ç”¨ Git
      uses: actions/checkout@v4
      with:
        # fetch-depth: 0 ç¡®ä¿æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥æ›´å¥½åœ°å¤„ç†å†²çª
        fetch-depth: 0 

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Dependencies (pandas)
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py

    - name: ğŸ’¾ Commit and Push Results
      # ä»…ä½¿ç”¨ file_patternï¼Œç§»é™¤æ‰€æœ‰å¯èƒ½å¼•èµ· v5 æŠ¥é”™çš„é¢å¤–å‚æ•°
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        file_pattern: output/**/*.csv 
        commit_options: '--date="${{ env.TZ_OFFSET }}"'
        # â­ æ–°å¢ï¼šåœ¨æ¨é€å‰æ‰§è¡Œæ‹‰å–å¹¶å°è¯•åˆå¹¶ (è¿™æ˜¯ Action çš„å†…ç½®åŠŸèƒ½ï¼Œä¸éœ€è¦ pull_options å‚æ•°)
        # å¦‚æœ Action å†…éƒ¨çš„è‡ªåŠ¨æ‹‰å–ä»å¤±è´¥ï¼Œæˆ‘ä»¬å°†å°è¯•åœ¨ä¸‹ä¸€æ­¥ä½¿ç”¨å¼ºåˆ¶æ¨é€ã€‚
        
    - name: ğŸš¨ Fallback
      # å¦‚æœä¸Šä¸€æ­¥å¤±è´¥ï¼Œè¿™è¯´æ˜è¿œç¨‹ä»“åº“åœ¨æˆ‘ä»¬æäº¤æœŸé—´è¢«ä¿®æ”¹äº†ã€‚
      # æˆ‘ä»¬å°†ä½¿ç”¨ä¸€ä¸ªå•ç‹¬çš„ Git å‘½ä»¤æ¥ç¡®ä¿æ¨é€ã€‚
      if: failure()
      run: |
        echo "Auto-commit failed due to remote changes. Pulling and retrying push."
        # é…ç½® Git èº«ä»½
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        # å°è¯•æ‹‰å–è¿œç¨‹ï¼Œå¹¶ä½¿ç”¨ 'ours' ç­–ç•¥è§£å†³å†²çª (æˆ‘ä»¬åªå…³å¿ƒè‡ªå·±çš„è¾“å‡ºæ–‡ä»¶)
        # æ›´å¥½çš„æ–¹æ³•æ˜¯ rebase
        git pull --rebase
        # æœ€åï¼Œå¼ºåˆ¶æ¨é€
        git push -f
