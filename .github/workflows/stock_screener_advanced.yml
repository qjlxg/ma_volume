name: Stock Screener Advanced Workflow
# è§¦å‘å™¨é…ç½®
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'
  schedule:
    - cron: '20 14 * * *'
  push:
    branches:
      - main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'
jobs:
  run_screener:
    runs-on: ubuntu-latest
    permissions:
      contents: write # æ˜¾å¼æˆäºˆå†™å…¥æƒé™
    env:
      TZ: 'Asia/Shanghai'
      TZ_OFFSET: '+0800' # UTC+8 offset
    steps:
    - name: â¬‡ï¸ Checkout Repository (Full History)
      uses: actions/checkout@v4
      with:
        # æ‹‰å–å®Œæ•´çš„å†å²è®°å½•ï¼Œä¸º rebase/push åšå‡†å¤‡
        fetch-depth: 0
    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    - name: ğŸ“¦ Install Dependencies (pandas)
      run: |
        python -m pip install --upgrade pip
        pip install pandas
    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py
    - name: ğŸ’¾ Commit Results Locally (Skip Push)
      # ğŸ’¥ ä¿®æ­£1ï¼šä»…åˆ›å»ºæœ¬åœ° commitï¼Œä¸è¿›è¡Œæ¨é€
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        file_pattern: output/**/*.csv
        commit_options: '--date="${{ env.TZ_OFFSET }}"'
        # æ ¸å¿ƒä¿®æ­£ï¼šè·³è¿‡æ¨é€ï¼Œé¿å… non-fast-forward é”™è¯¯
        skip_push: true
    - name: â¬†ï¸ Final Push with Conflict Resolution
      # ğŸ’¥ ä¿®æ­£2ï¼šä½¿ç”¨è‡ªå®šä¹‰å‘½ä»¤æ‰‹åŠ¨å¤„ç†æ‹‰å–å’Œæ¨é€
      run: |
        echo "Pushing commit with conflict resolution..."
        # 1. ç¡®ä¿ Git èº«ä»½è®¾ç½®
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        # 2. æ‹‰å–è¿œç¨‹æ›´æ”¹å¹¶ Rebase (å°†æˆ‘ä»¬çš„æ–° commit æ”¾åœ¨é¡¶éƒ¨)
        # Rebase æ˜¯è§£å†³å†²çªçš„æœ€ä½³æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¼šåˆ›å»ºä¸€ä¸ªå¹²å‡€çš„çº¿æ€§å†å²
        git pull --rebase
        # 3. æ¨é€ç»“æœã€‚ç”±äºå·²ç» rebaseï¼Œæ¨é€å°†æˆåŠŸ
        git push
        echo "Final push successful."
