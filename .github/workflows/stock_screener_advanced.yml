name: Stock Screener Advanced Workflow

# è§¦å‘å™¨é…ç½®
on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'Manual run reason (e.g., Debugging, Emergency)'
        required: false
        default: 'Manual Trigger'

  schedule:
    # UTC æ—¶é—´ 10:00ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´ (UTC+8) 18:00
    - cron: '0 18 * * *' 
  
  push:
    branches:
      - main
    paths:
      - 'stock_screener_advanced.py'
      - '.github/workflows/stock_screener_advanced.yml'


jobs:
  run_screener:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write # æ˜¾å¼æˆäºˆå†™å…¥æƒé™

    env:
      TZ: 'Asia/Shanghai' 
      # ğŸ’¥ ä¿®æ­£1: æ˜ç¡®å®šä¹‰ TZ_OFFSETï¼Œç¡®ä¿å®ƒä¸ä¼šä¸¢å¤±
      TZ_OFFSET: '+0800' 

    steps:
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿å¤„ç†å†²çª

    - name: ğŸ Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: ğŸ“¦ Install Dependencies (pandas)
      run: |
        python -m pip install --upgrade pip
        pip install pandas

    - name: ğŸƒ Run Stock Screener Script
      run: python stock_screener_advanced.py

    - name: ğŸ’¾ Commit and Push Results
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Automated: Add new stock screening results"
        file_pattern: output/**/*.csv 
        # ğŸ’¥ ä¿®æ­£2: ç¡®ä¿ä½¿ç”¨ env.TZ_OFFSET
        commit_options: '--date="${{ env.TZ_OFFSET }}"' 

    - name: ğŸš¨ 
      # ä»…åœ¨ä¸Šä¸€æ­¥å¤±è´¥æ—¶æ‰§è¡Œ (é€šå¸¸æ˜¯ç”±äºè¿œç¨‹åˆ†æ”¯æ›´æ–°å¯¼è‡´æ¨é€è¢«æ‹’ç»)
      if: failure()
      run: |
        echo "Auto-commit failed due to Git conflict. Initiating fallback push."
        
        # 1. å¼ºåˆ¶å°†ç”Ÿæˆçš„æ–°æ–‡ä»¶æ·»åŠ åˆ°æš‚å­˜åŒº
        # ğŸ’¥ ä¿®æ­£3: è§£å†³ 'Your index contains uncommitted changes' é”™è¯¯
        git add output/**/*.csv 

        # 2. é…ç½® Git èº«ä»½ (è‹¥ Action å¤±è´¥å¯èƒ½ä¸¢å¤±)
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        # 3. æ‹‰å–è¿œç¨‹æ›´æ”¹ï¼Œå¹¶å°†æˆ‘ä»¬çš„ commit æ”¾åœ¨æœ€ä¸Šé¢
        git pull --rebase
        
        # 4. å¼ºåˆ¶æ¨é€ (å› ä¸ºæˆ‘ä»¬å·²ç»è§£å†³äº†å†²çª)
        git push -f
        echo "Fallback push successful."
