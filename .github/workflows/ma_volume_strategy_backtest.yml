name: MA Volume Strategy Backtest and Screener

# è§¦å‘æ¡ä»¶
on:
  # å…è®¸æ‰‹åŠ¨ä» GitHub Actions ç•Œé¢è¿è¡Œ
  workflow_dispatch:
  # å½“ä»¥ä¸‹æ–‡ä»¶è¢«æ¨é€(Push)åˆ° main åˆ†æ”¯æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main
    paths:
      - 'ma_volume_strategy.py'
      - 'ma_volume_strategy_backtester.py'
      - '.github/workflows/ma_volume_strategy_backtest.yml'

jobs:
  run_screener_and_push_results:
    runs-on: ubuntu-latest
    
    # ä½¿ç”¨ GitHub æä¾›çš„ GITHUB_TOKENï¼Œè¿™å…è®¸æˆ‘ä»¬å‘ä»“åº“æ¨é€æ•°æ®
    permissions:
      contents: write 
      
    env:
      PYTHON_VERSION: '3.10'
      # è®¾ç½®æ—¶åŒºç¯å¢ƒå˜é‡ï¼Œæ–¹ä¾¿åœ¨æ—¥å¿—ä¸­ç¡®è®¤
      TZ: 'Asia/Shanghai'
      
    steps:
      - name: 1. Checkout repository
        uses: actions/checkout@v4
        # å¿…é¡»å¼€å¯ fetch-depth: 0 æ‰èƒ½åœ¨åç»­æäº¤æ—¶ä¿ç•™å®Œæ•´çš„ Git å†å²
        with:
          fetch-depth: 0 

      - name: 2. Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: 3. Install dependencies (pandas, pytz)
        run: |
          python -m pip install --upgrade pip
          pip install pandas pytz
          
      - name: 4. Verify Data and Log Timezone
        run: |
          echo "Starting workflow. Timezone is set to: $TZ"
          if [ ! -d "stock_data" ] || [ ! -f "stock_names.csv" ]; then
            echo "::error:: Missing 'stock_data' directory or 'stock_names.csv'. Please ensure data is present."
            exit 1
          fi

      - name: 5. ğŸƒ Run Backtest Script
        run: python ma_volume_strategy_backtester.py
        
      - name: 6. ğŸš€ Run Stock Screener Script (Generates Result CSV)
        run: python ma_volume_strategy.py
        
      - name: 7. ğŸ“¤ Commit and Push Results to Repository
        run: |
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # æ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ (é€šå¸¸åœ¨ /YYYY/MM/ ç›®å½•ä¸‹)
          git add .
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git status --porcelain | grep -q '??' || git status --porcelain | grep -q 'M'; then
            echo "New result files found. Committing..."
            # è·å–æœ€æ–°ç”Ÿæˆçš„ CSV æ–‡ä»¶è·¯å¾„ï¼Œç”¨äº commit message
            LATEST_RESULT=$(find . -path "*/screener_*.csv" -print0 | xargs -0 ls -t | head -1)
            
            # æäº¤å˜åŠ¨
            if [ -n "$LATEST_RESULT" ]; then
                git commit -m "Automated: New Screener Results from GitHub Actions. Latest: $(basename $LATEST_RESULT)"
            else
                git commit -m "Automated: New Screener and Backtest run."
            fi
            
            # æ¨é€åˆ°ä»“åº“
            git push
            echo "Successfully pushed new results to the repository."
          else
            echo "No new results or changes to commit."
          fi
