name: stacked_multi_cannon

run-name: stacked_multi_cannon

on:
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå› '
        required: false
        default: 'Manual run for stock scan'
  schedule:
    - cron: '39 13 * * *'
  push:
    branches: [ main, master ]
    paths:
      - 'stacked_multi_cannon_scanner.py'
      - '.github/workflows/stacked_multi_cannon_scanner.yml'

jobs:
  run_scanner_and_push:
    runs-on: ubuntu-latest
    # æˆäºˆå†™å…¥æƒé™
    permissions:
      contents: write
    
    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ›  å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install pandas pytz
          
      - name: è·‘ è¿è¡Œè‚¡ç¥¨æ‰«æè„šæœ¬
        run: python stacked_multi_cannon_scanner.py
        
      - name: ğŸ“‚ æ£€æŸ¥å˜åŠ¨å¹¶é…ç½® Git
        id: git_status
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add scan_results/
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ (æ–°è¯­æ³•)
          if git diff --cached --quiet; then
            echo "files_changed=false" >> $GITHUB_OUTPUT
          else
            echo "files_changed=true" >> $GITHUB_OUTPUT
          fi
          
      - name: â¬†ï¸ æ¨é€ç»“æœåˆ°ä»“åº“
        if: steps.git_status.outputs.files_changed == 'true'
        run: |
          now=$(date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ¤– è‡ªåŠ¨æ‰«æ: å å½¢å¤šæ–¹ç‚®å½¢æ€ç»“æœ - ${now}"
          # æ‹‰å–è¿œç¨‹å˜åŠ¨é˜²æ­¢å†²çªï¼Œä½¿ç”¨ rebase ä¿æŒæäº¤å†å²æ•´æ´
          git pull --rebase origin main
          git push origin main
