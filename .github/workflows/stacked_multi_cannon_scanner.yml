name: stacked_multi_cannon

# è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶åç»Ÿä¸€
run-name: stacked_multi_cannon
# è§¦å‘æ¡ä»¶
on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è§¦å‘åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual run for stock scan'
        
 
  schedule:
    - cron: '39 15 * * *' # 
    
  # 3. è‡ªåŠ¨è§¦å‘ (å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶)
  push:
    branches: [ main, master ]
    paths:
      - 'stacked_multi_cannon_scanner.py'
      - '.github/workflows/stacked_multi_cannon_scanner.yml'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'stacked_multi_cannon_scanner.py'
      - '.github/workflows/stacked_multi_cannon_scanner.yml'

jobs:
  run_scanner_and_push:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿ Python è„šæœ¬ä¸­çš„æ—¶é—´æˆ³æ­£ç¡®
    env:
      TZ: Asia/Shanghai

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        # éœ€è¦ token æ¥æ¨é€ç»“æœåˆ°ä»“åº“
        with:
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ›  å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          # å®‰è£… pandas å’Œ pytz åº“
          pip install pandas pytz
          
      # âš ï¸ å‡è®¾ stock_data ç›®å½•å’Œ stock_names.csv æ–‡ä»¶å·²ç»å­˜åœ¨äºä»“åº“æ ¹ç›®å½•
      # å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½ éœ€è¦æ·»åŠ é¢å¤–çš„æ­¥éª¤æ¥è·å–è¿™äº›æ•°æ®

      - name: ğŸƒ è¿è¡Œè‚¡ç¥¨æ‰«æè„šæœ¬
        # å¦‚æœ stock_data æˆ– stock_names.csv ä¸å­˜åœ¨ï¼Œè„šæœ¬ä¼šæŠ¥é”™å¹¶é€€å‡º
        run: python stacked_multi_cannon_scanner.py
        
      - name: ğŸ“‚ æ£€æŸ¥å˜åŠ¨å¹¶é…ç½® Git
        # è¿™ä¸€æ­¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ç»“æœæ–‡ä»¶ç”Ÿæˆ
        id: git_status
        run: |
          # é…ç½® Git ç”¨æˆ·ï¼Œç”¨äºæäº¤
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          # æ·»åŠ æ‰€æœ‰æ–°ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ (åœ¨ scan_results ç›®å½•ä¸‹)
          git add scan_results/
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨
          if git diff --cached --exit-code; then
            echo "::set-output name=files_changed::false"
          else
            echo "::set-output name=files_changed::true"
          fi
          
      - name: â¬†ï¸ æ¨é€ç»“æœåˆ°ä»“åº“
        # åªæœ‰å½“æœ‰æ–°ç»“æœæ–‡ä»¶æ—¶æ‰æ‰§è¡Œæ¨é€
        if: steps.git_status.outputs.files_changed == 'true'
        run: |
          now=$(TZ=Asia/Shanghai date +'%Y-%m-%d %H:%M:%S')
          git commit -m "ğŸ¤– è‡ªåŠ¨æ‰«æ: å å½¢å¤šæ–¹ç‚®å½¢æ€ç»“æœ - ${now}"
          git push
