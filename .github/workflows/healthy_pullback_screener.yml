name: Healthy Pullback Screener

# å®šä¹‰è§¦å‘å™¨
on:
  # 1. å®šæ—¶è§¦å‘ï¼šæ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶åŒº)
  schedule:
    # cronè¡¨è¾¾å¼åŸºäºUTCæ—¶é—´ï¼ŒåŒ—äº¬æ—¶é—´18:00 (UTC+8) ç›¸å½“äº UTC 10:00
    - cron: '0 15 * * *' 
  
  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (å¯é€‰)'
        required: false
        default: 'Manual trigger'
        
  # 3. è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œ
  push:
    branches:
      - main # å‡è®¾ä½ çš„ä¸»åˆ†æ”¯æ˜¯ main
    paths:
      - 'healthy_pullback_screener.py'
      - '.github/workflows/healthy_pullback_screener.yml'

jobs:
  screen_stocks:
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        # éœ€è¦æ‹‰å–æ‰€æœ‰å†å²è®°å½•ï¼Œä»¥ä¾¿è„šæœ¬èƒ½å¤Ÿæ‰«æ stock_data
        with:
          fetch-depth: 0

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: pip install pandas

      # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿è„šæœ¬ä¸­çš„ datetime.now() ä¸åŒ—äº¬æ—¶é—´ä¸€è‡´
      - name: ğŸŒ è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ· (UTC+8)
        run: export TZ='Asia/Shanghai'

      - name: âš™ï¸ è¿è¡Œè‚¡ç¥¨ç­›é€‰è„šæœ¬
        run: python healthy_pullback_screener.py

      - name: â¬†ï¸ æ¨é€ç»“æœæ–‡ä»¶åˆ°ä»“åº“
        # ç»“æœæ–‡ä»¶ä½äº /å¹´æœˆçš„å­ç›®å½•ä¸­ï¼Œéœ€è¦å°†æ•´ä¸ªç›®å½•æ·»åŠ å¹¶æ¨é€
        # GITHUB_TOKEN æ˜¯ Actions è‡ªåŠ¨æä¾›çš„æƒé™
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æŸ¥æ‰¾ä»Šå¤©ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ï¼ˆä½äºå¹´æœˆç›®å½•ï¼‰
          OUTPUT_DIR=$(date +%Y%m)
          
          # æ·»åŠ ç”Ÿæˆçš„å¹´æœˆç›®å½•åŠå…¶ä¸­çš„æ‰€æœ‰æ–‡ä»¶
          git add $OUTPUT_DIR/*.csv
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å˜åŠ¨ï¼ˆå³æ˜¯å¦æœ‰æ–°ç»“æœç”Ÿæˆï¼‰
          if git diff --cached --quiet; then
            echo "No new results to commit."
          else
            COMMIT_MESSAGE="Feat: Add healthy pullback screening results for $(date +%Y-%m-%d)"
            git commit -m "$COMMIT_MESSAGE"
            git push
            echo "Successfully pushed new results."
          fi
