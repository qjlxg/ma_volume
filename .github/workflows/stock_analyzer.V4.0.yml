name: ğŸ“ˆ -4_V4.0

# å®šä¹‰è§¦å‘æ¡ä»¶
on:
  # 1. æ¯æ—¥å®šæ—¶è¿è¡Œè§¦å‘ (UTC 10:00)
  schedule:
    - cron: '16 13 * * *' 
    
  # 2. æ‰‹åŠ¨è¿è¡Œè§¦å‘
  workflow_dispatch:
  
  # 3. å½“è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å‘ç”Ÿå˜åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œè§¦å‘
  push:
    branches:
      - main
    paths:
      - 'stock_analyzer.V4.0.py'
      - '.github/workflows/stock_analyzer.V4.0.yml'
      
# è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¼ºåˆ¶ä½¿ç”¨ä¸Šæµ·æ—¶åŒº
env:
  TZ: Asia/Shanghai
  OUTPUT_DIR_BASE: combined_results

jobs:
  analyze_and_push:
    runs-on: ubuntu-latest
    
    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # å¿…é¡»æ£€å‡ºæ‰€æœ‰å†å²ï¼Œä»¥ç¡®ä¿èƒ½æ‰¾åˆ°å†å² Combined_results ç›®å½•ä¸­çš„è¾“å…¥æ–‡ä»¶
          fetch-depth: 0

      # 2. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install pandas pytz pandas-ta

      # 4. è¿è¡Œåˆ†æè„šæœ¬
      - name: Run stock analysis script
        run: |
          # æ£€æŸ¥å¿…è¦çš„å†å²æ•°æ®ç›®å½•
          if [ ! -d stock_data ]; then
            echo "::error file=stock_data::Stock data directory 'stock_data' not found. Please create this directory and place historical CSV files inside."
            exit 1
          fi
          
          # è¿è¡Œè„šæœ¬
          python stock_analyzer.V4.0.py
          
      # 5. é…ç½® Git
      - name: Configure Git for commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      # 6. æäº¤å¹¶æ¨é€ç»“æœåˆ°ä»“åº“ (ä½¿ç”¨ stash å’Œ rebase å®‰å…¨è§£å†³å†²çª)
      - name: Commit and Push results
        run: |
          # è·å–å½“å‰ä¸Šæµ·æ—¥æœŸ
          DATE_SHANGHAI=$(TZ='Asia/Shanghai' date +%Y%m%d)
          RESULT_PATH="${OUTPUT_DIR_BASE}/${DATE_SHANGHAI}"
          
          # æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”å†…éƒ¨æ˜¯å¦æœ‰æ–°çš„æ—¶é—´æˆ³æ–‡ä»¶
          if [ ! -d "$RESULT_PATH" ] || [ -z "$(find $RESULT_PATH -type f -name 'combined_results_*.csv')" ]; then
            echo "No new time-stamped results found in ${RESULT_PATH}. Skipping commit."
            exit 0
          fi
          
          # ç¡®ä¿æ–°æ–‡ä»¶è¢«æ·»åŠ åˆ°æš‚å­˜åŒº
          git add "${OUTPUT_DIR_BASE}"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æäº¤çš„æ›´æ”¹
          if ! git diff --cached --exit-code; then
            
            # å…³é”®ä¿®å¤ï¼š1. å°†æœ¬åœ°çš„æ›´æ”¹ï¼ˆå³æ–°çš„ç»“æœæ–‡ä»¶ï¼‰æš‚å­˜èµ·æ¥
            git stash push -m "Stash analysis results"
            
            # å…³é”®ä¿®å¤ï¼š2. æ‹‰å–è¿œç¨‹æœ€æ–°çš„ main åˆ†æ”¯å†…å®¹ï¼Œå¹¶å°è¯•ç”¨ rebase æ•´åˆ
            git pull --rebase origin main
            
            # å…³é”®ä¿®å¤ï¼š3. æ¢å¤æœ¬åœ°æš‚å­˜çš„æ›´æ”¹ï¼ˆæ–°ç”Ÿæˆçš„ç»“æœæ–‡ä»¶ï¼‰
            git stash pop
            
            # 4. é‡æ–°æ·»åŠ å¹¶æäº¤
            git add "${OUTPUT_DIR_BASE}"
            git commit -m "Auto: ğŸ“ˆ Filtered technical analysis results for ${DATE_SHANGHAI} [skip ci]"
            
            # 5. æ¨é€
            git push
            echo "Successfully pushed analysis results."
          else
            echo "No changes to commit (results might be empty or unchanged)."
          fi
