name: 'ğŸ“Š åé‡è¿‡å‰é‡çªç ´'

on:
  # 1. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      reason:
        description: 'æ‰‹åŠ¨è¿è¡Œçš„åŸå›  (ä¾‹å¦‚: æµ‹è¯•, ç´§æ€¥è¿è¡Œ)'
        required: false
        default: 'Manual trigger'
        
  # 2. å®šæ—¶è§¦å‘ (æ¯å¤© 18:00 åŒ—äº¬æ—¶é—´/ä¸Šæµ·æ—¶åŒº)
  schedule:
    # cronè¡¨è¾¾å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨
    # 0 10 * * * UTCæ—¶é—´, å¯¹åº”åŒ—äº¬æ—¶é—´ 18:00 (UTC+8)
    - cron: '0 15 * * *'
    
  # 3. è„šæœ¬å’Œå·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    paths:
      - '.github/workflows/back_volume_exceeds_front_volume.yml'
      - 'back_volume_exceeds_front_volume.py'
      
jobs:
  filter_stocks:
    runs-on: ubuntu-latest
    
    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·æ—¶åŒº
    env:
      TZ: Asia/Shanghai

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # å®‰è£…æ‰€éœ€çš„ pandas åº“
          pip install pandas
          
      - name: Run Stock Filter Script
        # å‡è®¾ back_volume_exceeds_front_volume.py å’Œ stock_names.csv ä½äºä»“åº“æ ¹ç›®å½•
        # å‡è®¾ stock_data ç›®å½•å·²å­˜åœ¨å¹¶åŒ…å«æ‰€æœ‰å†å²æ•°æ®CSV
        run: |
          # ç¡®ä¿ stock_data ç›®å½•å­˜åœ¨ï¼Œé¿å…è„šæœ¬å› ç›®å½•ä¸å­˜åœ¨è€ŒæŠ¥é”™
          if [ ! -d "stock_data" ]; then
            echo "Warning: stock_data directory not found. Creating it now. Please ensure your data is uploaded."
            mkdir stock_data
          fi
          python back_volume_exceeds_front_volume.py

      # æäº¤ç»“æœåˆ°ä»“åº“
      - name: Commit and Push Results
        # åªæœ‰åœ¨è„šæœ¬æ‰§è¡ŒæˆåŠŸå¹¶ç”Ÿæˆäº†æ–°çš„ç»“æœæ–‡ä»¶æ—¶æ‰æäº¤
        # æ£€æŸ¥ 'ç­›é€‰ç»“æœ' ç›®å½•æ˜¯å¦è¢«åˆ›å»º
        if: success()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # åªæäº¤ 'ç­›é€‰ç»“æœ' ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶
          file_pattern: ç­›é€‰ç»“æœ/**/*.csv
          commit_message: 'ğŸ¤– è‡ªåŠ¨ç­›é€‰ï¼šåé‡è¿‡å‰é‡çªç ´ - ${{ github.event.head_commit.message || github.event_name }}'
          # ä½¿ç”¨ Actions æœºå™¨äººèº«ä»½æäº¤
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
          commit_author: github-actions[bot] <github-actions[bot]@users.noreply.github.com>
