name: up数据更新

# 定义触发工作流的事件
on:
  push:
    paths:
      - 'update.yml'
      - 'update.py'
      - '列表.txt'
      - 'results_data_update/progress.txt' 
      
  workflow_dispatch:
  
  schedule:
    # 每日北京时间 15:15（UTC 7:15）执行，用于确保每日数据更新
    - cron: '15 7 * * *'

# 定义工作流中的任务
jobs:
  update_data: 
    runs-on: ubuntu-latest
    
    steps:
      # 1. 检出代码 (必须获取完整历史记录和所有文件)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # fetch-depth: 0 确保拉取完整历史记录，进行 rebase 必须
          fetch-depth: 0 
          token: ${{ secrets.GITHUB_TOKEN }} 

      # 2. 设置 Python 环境
      - name: Set up Python 3.12
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          
      # 3. 安装依赖和中文字体 (保留中文字体，因为 akshare 的数据可能需要)
      - name: Install dependencies and fonts
        run: |
          python -m pip install --upgrade pip
          sudo apt-get update
          # 安装 gh CLI 和中文字体
          sudo apt-get install -y gh fonts-wqy-zenhei
          pip install akshare pandas numpy tqdm # 移除 matplotlib，但保留 tqdm
          
      # 4. 运行股票数据更新脚本并捕获退出码
      - name: Run stock data update script (Batch Processing)
        id: run_script
        run: |
          set +e # 允许脚本非零退出码不立即失败
          echo "Starting stock data update script (update.py)..."
          python update.py
          EXIT_CODE=$?
          echo "Script finished with exit code: $EXIT_CODE"
          
          # 将退出码保存为输出，供后续步骤使用
          echo "status=$EXIT_CODE" >> $GITHUB_OUTPUT
        
      # 5. 【修复推送冲突】将更新的文件提交并推送回仓库
      - name: Commit and push progress and data (Conflict Fix Applied)
        run: |
          # 配置 Git 身份
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # 【更新】：添加 stock_data 和新的 results_data_update 目录
          git add stock_data results_data_update 
          
          # 检查是否有文件需要提交
          if git diff --staged --quiet; then
            echo "No file changes to commit. Proceeding."
          else
            # 提交更改
            git commit -m "Automated data update: Save batch progress and data for $(date +%Y-%m-%d) (Exit Code: ${{ steps.run_script.outputs.status }})"
            
            # ------------------------------------------------------------------
            # 【关键修复】: 确保工作区干净，防止 git pull --rebase 报错
            # 清理未被 Git 追踪的文件和目录 (-fd)
            git clean -fd
            # 撤销所有未暂存的修改，确保工作区和索引区干净
            git reset --hard
            # ------------------------------------------------------------------
            
            # 【关键修复】: 在推送前拉取远程最新更改并执行 rebase 合并
            # 解决并发工作流可能导致的推送冲突
            git pull --rebase origin HEAD
            
            # 推送
            git push origin HEAD
            echo "Data batch committed and pushed successfully."
          fi
          
      # 6. 检查退出码，如果为 99，则使用 GH CLI 重启工作流
      - name: Check Status and Self-Restart Workflow
        # 仅在脚本退出码为 99 时运行此步骤
        if: steps.run_script.outputs.status == '99'
        run: |
          echo "Exit Code 99 detected: Attempting to restart workflow for next batch..."
          # 使用 gh CLI 触发当前工作流
          # 【修改 2】：将工作流文件名称改为 update.yml
          gh workflow run update.yml --ref ${{ github.ref }} || true
          echo "Workflow dispatch process finished."
        env:
          # 必须提供 GITHUB_TOKEN 用于 gh CLI 认证
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}