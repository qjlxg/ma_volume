# æ–‡ä»¶å: .github/workflows/bottom_double_bullish_scanner.yml

name: 'åº•éƒ¨åŒå€é˜³'

# è§¦å‘æ¡ä»¶é…ç½®
on:
  # 1. æ¯å¤© 18:00 (åŒ—äº¬æ—¶é—´) å®šæ—¶è§¦å‘
  schedule:
    # cron è¡¨è¾¾å¼ä½¿ç”¨ UTC æ—¶é—´ã€‚åŒ—äº¬æ—¶é—´ 18:00 (UTC+8) å¯¹åº” UTC 10:00ã€‚
    - cron: '0 10 * * *' 

  # 2. æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # 3. è„šæœ¬æˆ–å·¥ä½œæµæ–‡ä»¶å˜åŠ¨æ—¶è‡ªåŠ¨è§¦å‘
  push:
    branches:
      - main  # æ ¹æ®æ‚¨çš„ä¸»åˆ†æ”¯åç§°ä¿®æ”¹
    paths:
      - 'bottom_double_bullish_scanner.py'
      - '.github/workflows/bottom_double_bullish_scanner.yml'
      - 'stock_names.csv' 
      # ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ  stock_data/ ç›®å½•çš„å˜åŠ¨ï¼Œä½†é€šå¸¸ä¸å»ºè®®

# è¿è¡Œçš„ä»»åŠ¡
jobs:
  scan_and_push:
    runs-on: ubuntu-latest

    # è®¾ç½®æ—¶åŒºä¸ºä¸Šæµ·ï¼Œç¡®ä¿ Python è„šæœ¬ä¸­çš„æ—¶é—´æˆ³æ˜¯æ­£ç¡®çš„
    env:
      TZ: 'Asia/Shanghai'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          # éœ€è¦ token æ¥æ¨é€å›ä»“åº“
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x' 

      - name: âš™ï¸ Install dependencies (pandas, pytz)
        run: pip install pandas pytz

      - name: ğŸš€ Run Double Bullish Scanner Script
        run: python bottom_double_bullish_scanner.py

      # --- Git é…ç½®ä¸æ¨é€ ---
      - name: ğŸ“ Configure Git
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"

      - name: ğŸ” Check for new/modified files
        id: git_check
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ CSV æ–‡ä»¶è¢«åˆ›å»º (åœ¨ å¹´æœˆ/ ç›®å½•ä¸‹)
          # æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬åªå…³æ³¨è„šæœ¬è¿è¡Œååˆ›å»ºçš„ å¹´æœˆ/ ç›®å½•ä¸‹çš„ CSV æ–‡ä»¶
          NEW_FILES=$(find . -path "./20[0-9][0-9]-[0-9][0-9]/*_scanner_*.csv" -print -quit)
          if [ -n "$NEW_FILES" ]; then
            echo "::set-output name=files_changed::true"
          else
            echo "::set-output name=files_changed::false"
          fi

      - name: ğŸ“¦ Add and Commit results
        if: steps.git_check.outputs.files_changed == 'true'
        run: |
          # æ·»åŠ  å¹´æœˆ/ ç›®å½•ä¸‹çš„æ‰€æœ‰ CSV æ–‡ä»¶
          git add --force 20[0-9][0-9]-[0-9][0-9]/*.csv
          
          # æäº¤æ›´æ”¹
          COMMIT_MSG="[Action] åº•éƒ¨åŒå€é˜³å½¢æ€æ‰«æç»“æœï¼š$(date +'%Y-%m-%d %H:%M:%S')"
          git commit -m "$COMMIT_MSG"
          echo "Changes committed."

      - name: â¬†ï¸ Push changes to repository
        if: steps.git_check.outputs.files_changed == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }} # æ¨é€å›å½“å‰åˆ†æ”¯
